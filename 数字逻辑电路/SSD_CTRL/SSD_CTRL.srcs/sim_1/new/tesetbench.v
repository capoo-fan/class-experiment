/*
 * 模块: tb_top
 * 描述: 实验4 - top 模块的仿真激励文件 (Testbench)
 */
`timescale 1ns / 1ps // 定义仿真时间和精度

module tb_top;

    // --- 1. 激励信号 (reg) ---
    // 对应 top 模块的 input
    reg clk;
    reg S1;       // 复位
    reg S2;       // 启停
    reg S3;       // 计数
    reg SW0;      // 总使能

    // --- 2. 观测信号 (wire) ---
    // 对应 top 模块的 output
    wire [7:0] led_en;
    wire [7:0] led_cx;

    // --- 3. 观测内部信号 (推荐) ---
    // 为了方便在波形中查看 BCD 码, 我们直接观测 DUT 内部的 data_to_display
    // 'u_top' 是下面例化时使用的名字
    wire [31:0] data_bus;
    assign data_bus = u_top.display;

    // --- 4. 例化待测模块 (DUT: Device Under Test) ---
    top u_top (
        .clk(clk),
        .S1(S1),
        .S2(S2),
        .S3(S3),
        .SW0(SW0),
        .led_en(led_en),
        .led_cx(led_cx)
    );


    // --- 5. 生成 100MHz 时钟 ---
    // 周期为 10ns (5ns 高电平, 5ns 低电平)
    initial begin
        clk = 0;
    end
    always #5 clk = ~clk; // 每 5ns 翻转一次


    // --- 6. 仿真激励序列 ---
    initial begin
        $display("--- Testbench 开始 ---");

        // (1) 初始化 & 复位测试
        S1 = 1; S2 = 0; S3 = 0; SW0 = 0; // 初始状态
        #100; // 等待 100ns
        
        $display("T= %0t ns: (1) 触发异步复位 (S1=1)", $time);
        S1=0;
        #10;
        // 此时, 内部所有计数器都应为 0

        // (2) 启动显示 & 0.1s 计数器测试
        $display("T= %0t ns: (2) 启动数码管 (SW0=1), 观察 0.1s 计数器", $time);
        SW0 = 1; // 拨上总使能开关

        // *** 重要提示: 见下方说明 (1) ***
        // 0.1s = 100,000,000 ns. 仿真会很慢.
        // 等待 3.5 个 0.1s 周期, 观察 DK1-DK0
        #(100_000_000); // 0.1s 后, data_bus[7:0] 应为 8'h01
        #(100_000_000); // 0.2s 后, data_bus[7:0] 应为 8'h02
        #(100_000_000); // 0.3s 后, data_bus[7:0] 应为 8'h03

        // (3) 测试 S2 暂停功能
        $display("T= %0t ns: (3) 按下 S2 (暂停)", $time);
        S2 = 1; #10; S2 = 0; // 模拟一次按键 (消抖模块会处理)
        
        // 等待 0.2s, 计数值 (DK1-DK0) 应该保持在 8'h03 不变
        $display("T= %0t ns: ...等待 0.2s, 计数值应不变...", $time);
        #(200_000_000); 

        $display("T= %0t ns: (3) 再次按下 S2 (继续)", $time);
        S2 = 1; #10; S2 = 0; // 再次按键, 恢复计数

        #(100_000_000); // 0.1s 后, data_bus[7:0] 应为 8'h04
        #(100_000_000); // 0.1s 后, data_bus[7:0] 应为 8'h05

        
        // (4) 测试 S3 (无消抖 vs 有消抖)
        $display("T= %0t ns: (4) 模拟 S3 '干净' 按下", $time);
        S3 = 1; #20; S3 = 0; // 模拟一次 '干净' 按键
        #1_000_000; // 等待 1ms, 让边沿检测生效
        // 此时: DK5-4 (无消抖) 应为 8'h01
        //       DK3-2 (有消抖) 应为 8'h01 (因为干净按键也会被识别)

        $display("T= %0t ns: (4) 模拟 S3 '带抖动' 按下", $time);
        // 抖动发生在 20ms 消抖周期内
        S3 = 1; #1000; S3 = 0; // 抖动 1
        #2000;
        S3 = 1; #5000; S3 = 0; // 抖动 2
        #1000;
        S3 = 1; #2000; S3 = 0; // 抖动 3
        #10_000_000; // 等待 10ms
        S3 = 1; // 按键稳定按下
        #30_000_000; // 保持按下 30ms (确保超过 20ms 消抖)
        S3 = 0; // 释放按键
        #30_000_000; // 等待释放消抖
        
        // 此时检查:
        // DK5-4 (无消抖): 应该计数了多次 (e.g., 8'h05)
        // DK3-2 (有消抖): 应该只计数了 1 次 (总共 8'h02)

        // (5) 测试 SW0 关闭显示
        $display("T= %0t ns: (5) 关闭数码管 (SW0=0)", $time);
        SW0 = 0;
        #100_000_000; // 等待 0.1s
        // 此时: A 输出应为 8'hFF (全灭)
        //       但 data_bus[7:0] (内部计数器) 应仍在计数 (e.g., 变为 8'h06)

        $display("T= %0t ns: --- Testbench 结束 ---", $time);
        $finish; // 结束仿真
    end

endmodule